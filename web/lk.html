<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Личный кабинет — Учебный центр</title>
  <link rel="icon" href="assets/icons/favicon.png" type="image/png">
  <link rel="stylesheet" href="css/style.css">
  <style>

    /* Вертикальный список «Мои курсы» */
    .my-courses-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .course-item {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .course-item img {
      flex-shrink: 0;
      width: 60px;
      height: auto;
      object-fit: cover;
      margin: 20px;
    }
    .course-item .course-info {
      padding: 15px;
      flex: 1;
    }
    .course-item .course-info h4 {
      margin: 0 0 5px;
      color: var(--primary-2);
    }
    .course-item .course-info p {
      margin: 0;
      color: #555;
      font-size: 0.9rem;
    }
     /* — общий layout — */
    html, body { height:100%; margin:0; }
    body { font-family: Arial, sans-serif; background:#f9f9f9; }

    main {
      display: flex;
      gap: 20px;
      max-width: 1200px;
      margin: 120px auto 60px;
      padding: 0 20px;
    }

    /* — Sidebar — */
    .profile-sidebar {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      flex: 0 0 250px;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .profile-avatar {
      width: 95%;
      height: auto;
      border-radius: var(--border-radius);
      object-fit: cover;
      display: block;
      margin: 0 auto 15px;
    }
    .profile-sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: none;
      border-radius: var(--border-radius);
      color: #fff;
      cursor: pointer;
    }
    .btn-photo    { background: var(--secondaryA-4); }
    .btn-fio      { background: var(--secondaryB-4); }
    .btn-email    { background: var(--secondaryA-5); }
    .btn-phone    { background: var(--secondaryB-5); }
    .btn-exit     { background: #e74c3c; margin-top:20px; }

    /* — Main profile info — */
    .profile-main {
      flex:1;
      background:#fff;
      border-radius:var(--border-radius);
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      padding:20px;
    }
    .profile-main h2 { margin:0 0 10px; color:var(--primary-2); }
    .profile-main p { margin:0 0 5px; }

    /* — «Мои курсы» вертикальный список — */
    .my-courses-list {
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:15px;
    }
    .course-item {
      display:flex;
      align-items:center;
      background:#fff;
      border-radius:var(--border-radius);
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      overflow:hidden;
    }
    .course-item img {
      width:60px;
      height:60px;
      object-fit:cover;
      margin:20px;
    }
    .course-info { padding:15px; }
    .course-info h4 { margin:0 0 5px; color:var(--primary-2); }
    .course-info p { margin:0; color:#555; font-size:.9rem; }

    /* — Модальное окно для редактирования — */
    #modal-bg {
      display:none;
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.6);
      justify-content:center; align-items:center;
      z-index:10000;
    }
    #modal {
      background:#fff;
      padding:20px;
      border-radius:var(--border-radius);
      width:300px;
      text-align:center;
    }
    #modal input {
      width:100%; padding:8px; margin-bottom:15px;
      border:1px solid #ccc; border-radius:var(--border-radius);
    }
    #modal button {
      padding:8px 16px;
      border:none; border-radius:var(--border-radius);
      background:var(--secondaryA-4); color:#fff;
      cursor:pointer;
    }
    .enroll-section {
      background: #fff;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .enroll-section h3 {
      margin-top: 0;
      color: var(--primary-3);
      font-size: 1.2rem;
    }
    .enroll-section select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
    }
    .enroll-section button {
      display: inline-block;
      padding: 12px 24px;
      background: var(--secondaryB-1);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    .enroll-section button:hover {
      background: var(--secondaryB-2);
    }
    #enroll-message {
      margin-top: 10px;
      font-size: 0.95rem;
    }
  </style>
  <script>
  // в <head> или перед </body> – не важно, главное чтобы этот скрипт
  // выполнился один раз и навесил обработчик на document
  document.addEventListener('click', function(e) {
    // если кликнули по кнопке смены фото
    if (e.target && e.target.id === 'change-photo-btn') {
      // просто прокидываем click в скрытый input[type=file]
      document.getElementById('photo-input').click();
    }
  });
</script>
</head>
<body>
  <!-- фиксированное меню -->
  <header class="site-header">
    <nav class="main-nav">
      <button class="menu-toggle" aria-label="Меню">
        <img src="assets/icons/menu.png" alt="Меню" class="menu-icon">
      </button>
      <ul class="nav-links">
          <li><a href="index" class="active">Главная</a></li>
          <li><a href="news">Новости</a></li>
          <li><a href="reviews">Отзывы</a></li>
          <li><a href="about">О нас</a></li>
      </ul>
      <ul class="auth-links">
        <li>
          <a href="lk" class="active" id="log-act">Загрузка...</a>
        </li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Sidebar -->
    <aside class="profile-sidebar">
      <img id="avatar"
       src="assets/images/placeholder.png"
       alt="Аватар"
       class="profile-avatar">
      <!-- сменить фото -->
      <button class="btn-photo"    id="change-photo-btn">Сменить фото</button>
      <input type="file"            id="photo-input" accept="image/*" style="display:none">
      <!-- сменить ФИО -->
      <button class="btn-fio"      id="change-fio-btn">Сменить имя</button>
      <!-- сменить email -->
      <button class="btn-email"    id="change-email-btn">Сменить email</button>
      <!-- сменить телефон -->
      <button class="btn-phone"    id="change-phone-btn">Сменить телефон</button>
      <!-- выйти -->
      <button class="btn-exit"     id="logout-btn">Выйти из личного кабинета</button>
    </aside>

    <!-- Основной контент -->
    <section class="profile-main">
      <h2 id="user-name">Загрузка…</h2>
      <p><strong>Email:</strong> <span id="user-email">–</span></p>
      <p><strong>Телефон:</strong> <span id="user-phone">–</span></p>

      <div class="enroll-section">
        <h3>Записаться на курс</h3>
        <select id="enroll-select">
          <option value="" disabled selected>Загрузка курсов…</option>
        </select>
        <button id="enroll-btn">Записаться</button>
        <div id="enroll-message"></div>
      </div>

      <h3>Мои курсы</h3>
      <div class="my-courses-list" id="courses-list">
        <!-- сюда JS подставит блоки -->
      </div>
    </section>
  </main>

  <!-- Подвал -->
  <footer class="site-footer">
        <div class="footer-top">
            <div class="footer-logo-desc">
                <img src="assets/images/footer-logo.png" alt="Логотип" class="footer-logo">
                <p>CodeBrothers — учебный IT-центр из Нижнего Новгорода.</p>
                <p>Учим программировать вместе и по-братски.</p>
            </div>
            <div class="footer-links">
                <a href="catalog">Каталог курсов</a>
                <a href="schedule">Расписание</a>
                <a href="about">О нас</a>
                <a href="reviews">Отзывы</a>
            </div>
            <div class="footer-links" id="centers">
                <h4>Учебные центры</h4>
                <a href="centers">ул. Ульянова, 1</a>
                <a href="centers">ул. Ульянова, 10а</a>
                <a href="centers">ул. Челюскинцев, 9</a>
            </div>
        </div>
        <hr>
        <div class="footer-bottom">
            <div class="footer-copy">© 2025 Все права защищены</div>
            <div class="footer-policy">
                <a href="docs/Соглашение на обработку персональных данных.pdf">Соглашение на обработку персональных данных</a>
                <a href="docs/Политика конфиденциальности.pdf">Политика конфиденциальности</a>
                <a href="docs/Сведения об образовательной организации.pdf">Сведения об образовательной организации</a>
                <a href="docs/Информация об оплате.pdf">Информация об оплате</a>
            </div>
            <div class="footer-social">
                <a href="https://vk.com" target="_blank"><i class="fab fa-vk"></i></a>
                <a href="https://t.me" target="_blank"><i class="fab fa-telegram"></i></a>
            </div>
        </div>
    </footer>

  <script src="js/main.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  // Проверяем, что все элементы на месте:
  const avatarImg   = document.getElementById('avatar');
  const nameEl      = document.getElementById('user-name');
  const emailEl     = document.getElementById('user-email');
  const phoneEl     = document.getElementById('user-phone');
  const coursesList = document.getElementById('courses-list');
  const logact = document.getElementById('log-act');
  

  if (!avatarImg || !nameEl || !emailEl || !phoneEl || !coursesList) {
    console.error('Один из элементов профиля не найден в DOM');
    return;
  }

  fetch('/api/lk', { method: 'GET' })
  .then(res => {
    if (res.status === 401) {
      alert('Нужно войти в систему');
      window.location.href = '/main/login';
      throw new Error('unauthorized');
    }
    if (!res.ok) {
      throw new Error('Ошибка сервера: ' + res.status);
    }
    return res.json();
  })
  .then(json => {
    console.log('Профиль пользователя:', json);  // <-- вот здесь обязательно посмотрите в консоли, что реально приходит

    const u = json;
    avatarImg.src               = u.photo;
    nameEl.textContent          = u.fio;
    logact.textContent = u.fio;
    emailEl.textContent         = u.email;
    phoneEl.textContent         = u.phone;

    // «Мои курсы»
    coursesList.innerHTML = '';
    (u.courses || []).forEach(c => {
      const div = document.createElement('div');
      div.className = 'course-item';
      div.innerHTML = `
        <img src="${c.image}" alt="${c.title}">
        <div class="course-info">
          <h4>${c.title}</h4>
          <p>${c.description||''}</p>
        </div>`;
      coursesList.appendChild(div);
    });
  })
  .catch(err => console.error(err));
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const fileInput = document.getElementById('photo-input');
  if (!fileInput) {
    console.error('photo-input не найден');
    return;
  }

  fileInput.addEventListener('change', function(e) {
    console.log('change fired!');
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      fetch('/api/lk/changephoto', {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ changing: reader.result })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Ошибка сервера: ${response.status}`);
        }
        // Сервер не возвращает тело — считаем, что всё прошло успешно
       // avatarImg.src = dataUrl;
        document.getElementById('avatar').src = reader.result;
      })
    };
    reader.readAsDataURL(file);
    
  });

  //     fetch('/api/lk/changephoto', {
  //       method: 'PUT',
  //       credentials: 'include',
  //       headers: { 'Changing': 'application/json'},
  //       body: JSON.stringify({ photo: base64 })
  //     })
  //     .then(res => {
  //       if (!res.ok) throw new Error('Ошибка ' + res.status);
  //       return res.json();
  //     })
  //     .then(json => {
  //       document.getElementById('avatar').src = json.data.photo || base64;
  //       alert('Фото профиля успешно обновлено');
  //     })
  //     .catch(err => {
  //       console.error(err);
  //       alert('Не удалось обновить фото');
  //     });
  //   };
  //   reader.readAsDataURL(file);
  // });
});
</script>

<script>
function showChangeNameModal(onSave) {
  // Оверлей
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position:'fixed', top:0, left:0, right:0, bottom:0,
    background:'rgba(0,0,0,0.5)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:1000
  });

  // Контейнер модалки
  const modal = document.createElement('div');
  Object.assign(modal.style, {
    background:'#fff', padding:'20px', borderRadius:'5px',
    width:'300px', boxSizing:'border-box',
    boxShadow:'0 2px 10px rgba(0,0,0,0.1)'
  });

  // Заголовок
  const title = document.createElement('h2');
  title.textContent = 'Сменить имя';
  title.style.marginTop = 0;

  // Поле ввода
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Новое имя';
  Object.assign(input.style, {
    width:'100%', padding:'8px', margin:'10px 0', boxSizing:'border-box'
  });

  // Кнопки
  const btnSave = document.createElement('button');
  btnSave.textContent = 'Сохранить';
  btnSave.style.marginRight = '10px';

  const btnCancel = document.createElement('button');
  btnCancel.textContent = 'Отмена';

  modal.append(title, input, btnSave, btnCancel);
  overlay.append(modal);
  document.body.append(overlay);

  // Закрытие модалки
  function close() { overlay.remove(); }
  btnCancel.addEventListener('click', close);

  // Обработка «Сохранить»
  btnSave.addEventListener('click', () => {
    const newName = input.value.trim();
    if (!newName) {
      alert('Имя не может быть пустым');
      return;
    }
    onSave(newName);
    close();
  });
}

// Привязываем модалку к кнопке
document.getElementById('change-fio-btn')
  .addEventListener('click', () => {
    showChangeNameModal(newName => {
      // Отправляем только новое имя
      fetch('/api/lk/changefio', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changing: newName })
      })
      .then(data => {
        //alert('Имя успешно обновлено на сервере');
        // при необходимости обновить UI на странице:
        document.getElementById('user-name').textContent = newName;
        document.getElementById('log-act').textContent = newName;
      })
      .catch(err => {
        console.error(err);
        alert('Не удалось сохранить имя: ' + err.message);
      });
    });
  });
</script>

<script>
// Функция показа модалки для изменения e‑mail
function showChangeEmailModal(onSave) {
  // Оверлей
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
    background: 'rgba(0,0,0,0.5)', display: 'flex',
    alignItems: 'center', justifyContent: 'center', zIndex: 1000
  });

  // Контейнер модалки
  const modal = document.createElement('div');
  Object.assign(modal.style, {
    background: '#fff', padding: '20px', borderRadius: '5px',
    width: '320px', boxSizing: 'border-box',
    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
  });

  // Заголовок
  const title = document.createElement('h2');
  title.textContent = 'Сменить e‑mail';
  title.style.marginTop = '0';

  // Поле ввода
  const input = document.createElement('input');
  input.type = 'email';
  input.placeholder = 'Новый e‑mail';
  Object.assign(input.style, {
    width: '100%', padding: '8px', margin: '12px 0', boxSizing: 'border-box'
  });

  // Кнопки
  const btnSave = document.createElement('button');
  btnSave.textContent = 'Сохранить';
  btnSave.style.marginRight = '10px';

  const btnCancel = document.createElement('button');
  btnCancel.textContent = 'Отмена';

  // Собираем модалку
  modal.append(title, input, btnSave, btnCancel);
  overlay.append(modal);
  document.body.append(overlay);

  // Закрытие
  function close() { overlay.remove(); }
  btnCancel.addEventListener('click', close);

  // Обработка «Сохранить»
  btnSave.addEventListener('click', () => {
    const newEmail = input.value.trim();
    // Базовая валидация e‑mail
    if (!newEmail) {
      alert('E‑mail не может быть пустым');
      return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
      alert('Неверный формат e‑mail');
      return;
    }
    onSave(newEmail);
    close();
  });
}

// Привязываем к кнопке смены e‑mail
document.getElementById('change-email-btn')
  .addEventListener('click', () => {
    showChangeEmailModal(newEmail => {
      fetch('/api/lk/changeemail', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changing: newEmail })
      })
      .then(response => {
        if (!response.ok) throw new Error(`Сервер вернул ${response.status}`);
        alert('E‑mail успешно обновлён');
        // Обновляем отображение на странице
        const emailDisplay = document.getElementById('user-email');
        if (emailDisplay) {
          emailDisplay.textContent = newEmail;
        }
      })
      .catch(err => {
        console.error(err);
        alert('Не удалось сохранить e‑mail: ' + err.message);
      });
    });
  });
</script>

<script>
// Функция показа модалки для изменения телефона
function showChangePhoneModal(onSave) {
  // Оверлей
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
    background: 'rgba(0,0,0,0.5)', display: 'flex',
    alignItems: 'center', justifyContent: 'center', zIndex: 1000
  });

  // Контейнер модалки
  const modal = document.createElement('div');
  Object.assign(modal.style, {
    background: '#fff', padding: '20px', borderRadius: '5px',
    width: '320px', boxSizing: 'border-box',
    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
  });

  // Заголовок
  const title = document.createElement('h2');
  title.textContent = 'Сменить телефон';
  title.style.marginTop = '0';

  // Поле ввода
  const input = document.createElement('input');
  input.type = 'tel';
  input.placeholder = 'Новый телефон';
  Object.assign(input.style, {
    width: '100%', padding: '8px', margin: '12px 0', boxSizing: 'border-box'
  });

  // Кнопки
  const btnSave = document.createElement('button');
  btnSave.textContent = 'Сохранить';
  btnSave.style.marginRight = '10px';

  const btnCancel = document.createElement('button');
  btnCancel.textContent = 'Отмена';

  // Собираем модалку
  modal.append(title, input, btnSave, btnCancel);
  overlay.append(modal);
  document.body.append(overlay);

  // Закрытие
  function close() { overlay.remove(); }
  btnCancel.addEventListener('click', close);

  // Обработка «Сохранить»
  btnSave.addEventListener('click', () => {
    const newPhone = input.value.trim();
    // Базовая валидация телефона: цифры, пробелы, дефисы и +
    if (!newPhone) {
      alert('Телефон не может быть пустым');
      return;
    }
    if (!/^[\d+\-\s]+$/.test(newPhone)) {
      alert('Неверный формат телефона');
      return;
    }
    onSave(newPhone);
    close();
  });
}

// Привязываем к кнопке смены телефона
document.getElementById('change-phone-btn')
  .addEventListener('click', () => {
    showChangePhoneModal(newPhone => {
      fetch('/api/lk/changephone', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changing: newPhone })
      })
      .then(response => {
        if (!response.ok) throw new Error(`Сервер вернул ${response.status}`);
        alert('Телефон успешно обновлён');
        // Обновляем отображение на странице
        const phoneDisplay = document.getElementById('user-phone');
        if (phoneDisplay) {
          phoneDisplay.textContent = newPhone;
        }
      })
      .catch(err => {
        console.error(err);
        alert('Не удалось сохранить телефон: ' + err.message);
      });
    });
  });
</script>

<script>
document.getElementById('logout-btn')
  .addEventListener('click', () => {
    // Отправляем запрос на выход
    fetch('/api/auth/logout', {
      method: 'POST',            // или 'GET', в зависимости от вашего API
      credentials: 'include'     // чтобы передать куки при необходимости
    })
    .then(response => {
      window.location.href = '/main/login';
    })
    .catch(err => {
      console.error('Ошибка при выходе:', err);
      alert('Не удалось выйти: ' + err.message);
    });
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('enroll-select');
  if (!select) {
    console.error('enroll-select не найден');
    return;
  }

  // Показать placeholder загрузки
  select.innerHTML = '<option value="" disabled selected>Загрузка курсов…</option>';

  fetch('/api/courses', {
    method: 'GET',
    headers: { 'Accept': 'application/json' },
    credentials: 'include'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Ошибка загрузки: ${response.status}`);
    }
    return response.json();
  })
  .then(json => {
    // API отдаёт объект { data: [ ... ] }
    const courses = Array.isArray(json.data) ? json.data : [];

    if (courses.length === 0) {
      select.innerHTML = '<option value="" disabled>Нет доступных курсов</option>';
      return;
    }

    // Сбросить placeholder и добавить приглашение выбрать
    select.innerHTML = '<option value="" disabled selected>Выберите курс…</option>';

    courses.forEach(course => {
      const opt = document.createElement('option');
      opt.value = course.id;         // id курса как value
      opt.textContent = course.title; // отображаемое название — title
      select.appendChild(opt);
    });
  })
  .catch(err => {
    console.error(err);
    select.innerHTML = '<option value="" disabled selected>Не удалось загрузить курсы</option>';
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnEnroll = document.getElementById('enroll-btn');
  const select   = document.getElementById('enroll-select');

  if (!btnEnroll || !select) {
    console.error('enroll-btn или enroll-select не найдены');
    return;
  }

  btnEnroll.addEventListener('click', () => {
    const courseId = select.value;
    if (!courseId) {
      alert('Пожалуйста, выберите курс');
      return;
    }

    fetch('/api/lk/addcourse', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ id: courseId })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Сервер вернул ${response.status}`);
      }
      return response.json().catch(() => ({})); // если тело пустое
    })
    .then(() => {
      //alert('Вы успешно записались на курс!');
      window.location.reload();
    })
    .catch(err => {
      console.error('Ошибка при записи на курс:', err);
      alert('Не удалось записаться на курс: ' + err.message);
    });
  });
});
</script>

</body>
</html>
